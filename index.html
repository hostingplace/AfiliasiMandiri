<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel — Affiliate Dashboard</title>
  <style>
    :root{--bg:#f3fbff;--card:#e6f7ff;--accent:#66c2ff;--muted:#6b8596;font-family:Inter,system-ui,Arial}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#eef9ff);color:#083042}
    .wrap{max-width:1100px;margin:32px auto;padding:20px}
    .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 20px rgba(6,30,45,0.06)}
    h1{margin:0 0 12px 0}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;text-align:left;border-bottom:1px solid rgba(6,30,45,0.06)}
    button{padding:6px 10px;border-radius:8px;border:0;background:var(--accent);color:white;cursor:pointer}
    button.alt{background:transparent;color:var(--accent);border:1px solid rgba(6,30,45,0.06)}
    .controls{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .muted{color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h1>Admin Panel — Withdraw Requests</h1>
      <div class="muted">Storage key: <strong>affiliate_v2</strong></div>
    </div>

    <div class="card">
      <div class="controls">
        <input id="filterUser" placeholder="Filter by user name" />
        <button onclick="loadAndRender()" class="alt">Refresh</button>
        <button onclick="exportWithdraws()">Export CSV</button>
        <button onclick="resetAll()" class="alt">Reset All Data (danger)</button>
      </div>

      <table aria-label="withdraws" id="tblWithdraws">
        <thead>
          <tr><th>ID</th><th>User</th><th>Amount</th><th>Fee</th><th>Final</th><th>Method</th><th>Account</th><th>Time</th><th>Status</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>

    </div>

    <div style="height:18px"></div>
    <div class="card" id="membersCard">
      <h2 style="margin-top:0">Members Snapshot</h2>
      <div id="membersList" class="muted"></div>
    </div>

  </div>

<script>
const STORAGE_KEY = 'affiliate_v2';
function loadDB(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {members:{},logs:[],withdraws:[]}; }catch(e){return {members:{},logs:[],withdraws:[]};}
}
function saveDB(db){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }

function formatRupiah(n){ return 'Rp' + Number(n).toLocaleString('id-ID'); }

function loadAndRender(){
  const db = loadDB();
  const tbody = document.querySelector('#tblWithdraws tbody'); tbody.innerHTML='';
  const filter = (document.getElementById('filterUser').value||'').trim().toLowerCase();
  (db.withdraws||[]).slice().reverse().forEach(w=>{
    if(filter && (w.user||'').toLowerCase().indexOf(filter)===-1) return;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${w.id}</td>
      <td>${w.user}</td>
      <td>${formatRupiah(w.amount)}</td>
      <td>${formatRupiah(w.fee)}</td>
      <td>${formatRupiah(w.final)}</td>
      <td>${w.method}</td>
      <td>${w.account}</td>
      <td>${w.time}</td>
      <td>${w.status}</td>
      <td></td>
    `;
    const tdAction = tr.querySelector('td:last-child');
    if(w.status === 'pending'){
      const btnApprove = document.createElement('button'); btnApprove.textContent='Approve'; btnApprove.onclick = ()=>approveWithdraw(w.id);
      const btnCancel = document.createElement('button'); btnCancel.textContent='Cancel'; btnCancel.className='alt'; btnCancel.style.marginLeft='6px'; btnCancel.onclick=()=>cancelWithdraw(w.id);
      tdAction.appendChild(btnApprove); tdAction.appendChild(btnCancel);
    } else {
      tdAction.textContent = '—';
    }
    tbody.appendChild(tr);
  });

  // members snapshot
  const membersDiv = document.getElementById('membersList');
  const lines = Object.keys(db.members||{}).map(k=>{
    const m = db.members[k]; return `${m.displayName} — Saldo: ${formatRupiah(m.balance||0)} — Komisi: ${ (m.commissions||[]).length }`;
  });
  membersDiv.innerHTML = lines.join('<br>') || '<em>No members</em>';
}

function approveWithdraw(id){
  const db = loadDB();
  const idx = (db.withdraws||[]).findIndex(x=>x.id===id);
  if(idx===-1) return alert('Request not found');
  const w = db.withdraws[idx];
  if(w.status !== 'pending') return alert('Not pending');
  const memberKey = w.user;
  // ensure member exists
  if(!db.members[memberKey]){ alert('Member data not found.'); return; }
  const member = db.members[memberKey];
  // check balance
  if((member.balance||0) < w.amount){
    if(!confirm('Saldo member tidak cukup. Setujui dan kurangi sampai 0?')) return;
  }
  // deduct amount from member
  member.balance = Math.max(0, (member.balance||0) - w.amount);
  // mark withdraw approved
  w.status = 'approved';
  w.approvedAt = new Date().toLocaleString();
  db.logs = db.logs || [];
  db.logs.unshift({t:new Date().toLocaleString(), txt:`Withdraw ${w.id} approved by admin`});
  saveDB(db);
  loadAndRender();
  alert('Withdraw approved. Ingat: Admin harus mengirim uang secara manual ke tujuan yang tercantum.');
}
function cancelWithdraw(id){
  const db = loadDB();
  const idx = (db.withdraws||[]).findIndex(x=>x.id===id);
  if(idx===-1) return alert('Request not found');
  const w = db.withdraws[idx];
  w.status = 'cancelled';
  db.logs = db.logs || [];
  db.logs.unshift({t:new Date().toLocaleString(), txt:`Withdraw ${w.id} cancelled by admin`});
  saveDB(db); loadAndRender();
}

function exportWithdraws(){
  const db = loadDB(); const rows = [['id','user','amount','fee','final','method','account','time','status']].concat((db.withdraws||[]).map(w=>[w.id,w.user,w.amount,w.fee,w.final,w.method,w.account,w.time,w.status]));
  const csv = rows.map(r=>r.map(x=>`"${String(x||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='withdraws.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

function resetAll(){ if(!confirm('Reset ALL local data?')) return; localStorage.removeItem(STORAGE_KEY); loadAndRender(); alert('Data direset'); }

// init
loadAndRender();
</script>
</body>
</html>

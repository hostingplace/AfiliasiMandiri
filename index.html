<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Affiliate Dashboard — Sistem Uang Berputar</title>

<style>
  :root{
    --bg:#f3fbff;--card:#e6f7ff;--accent:#66c2ff;--accent-2:#8fd6ff;
    --muted:#6b8596;--glass: rgba(255,255,255,0.6);--success:#23c48a;
    --danger:#ff6b6b;font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,var(--bg),#eef9ff);color:#083042}
  .container{max-width:1100px;margin:28px auto;padding:20px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));
        display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
  h1{margin:0;font-size:20px}
  .sub{color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 20px rgba(6,30,45,0.06)}
  .col-4{grid-column:span 4}
  .col-8{grid-column:span 8}
  .col-12{grid-column:span 12}
  .overview{display:flex;gap:12px}
  .kpi{flex:1;padding:12px;border-radius:10px;background:rgba(255,255,255,0.5)}
  .kpi h3{margin:0;font-size:14px;color:var(--muted)}
  .kpi p{margin-top:8px;margin-bottom:0;font-weight:700;font-size:20px}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:8px;text-align:left}
  thead th{color:var(--muted);font-size:13px}
  tbody tr{border-top:1px solid rgba(8,48,66,0.06)}
  .badge{padding:6px 8px;border-radius:999px;font-size:12px;background:var(--glass)}
  .badge.pending{background:#fff3cd;color:#a37c00}
  .badge.paid{background:#e6f0ff;color:#1557ff}
  .badge.approved{background:#e6fff3;color:#23c48a}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  input,select{padding:8px;border-radius:8px;border:1px solid rgba(6,30,45,0.08);min-width:160px}
  button{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:white;cursor:pointer}
  button.alt{background:transparent;color:var(--accent);border:1px solid rgba(6,30,45,0.06)}
  footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
  .muted{color:var(--muted)}
  #ownerArea{display:none}
  .admin-panel{background:white;padding:12px;border-radius:10px;margin-top:12px}

  /* Withdraw modal */
  #withdrawModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.25);
    align-items:center;justify-content:center;}
  #withdrawBox{background:white;padding:18px;border-radius:12px;max-width:420px;width:90%;
    box-shadow:0 10px 30px rgba(0,0,0,0.2)}
</style>
</head>
<body>

<div class="container">

<header>
  <div class="brand">
    <div class="logo" id="logoTxt">AF</div>
    <div>
      <h1 id="title">Nama Member</h1>
      <div class="sub">Light blue theme — Sistem uang berputar (localStorage).</div>
    </div>
  </div>

  <div style="text-align:right">
    <div id="balanceDisplay" style="font-weight:700;font-size:16px">Saldo: Rp0</div>
    <div class="sub">Status: <span id="withdrawStatus">Ready</span></div>
  </div>
</header>


<main class="grid">
  <!-- LEFT -->
  <section class="card col-8">

    <div style="display:flex;justify-content:space-between;margin-bottom:10px">
      <strong>Ringkasan</strong>
      <div class="controls">
        <button class="alt" onclick="seedDemo()">Isi Demo</button>
        <button onclick="exportCSV()">Export CSV</button>
        <button class="alt" onclick="resetData()">Reset</button>
      </div>
    </div>

    <div class="overview">
      <div class="kpi"><h3>Total Klik</h3><p id="totalClicks">0</p></div>
      <div class="kpi"><h3>Total Penjualan</h3><p id="totalSales">0</p></div>
      <div class="kpi"><h3>Total Komisi</h3><p id="totalCommission">Rp0</p></div>
    </div>

    <hr style="border:none;height:12px">

    <strong>Riwayat Komisi</strong>
    <table>
      <thead><tr><th>Waktu</th><th>Order</th><th>Biaya</th><th>Jumlah</th><th>Status</th><th>Aksi</th></tr></thead>
      <tbody id="commissionTable"></tbody>
    </table>

    <div id="ownerArea">
      <strong>Panel Owner — Withdraw Requests</strong>
      <div class="admin-panel" id="ownerPanel"></div>
    </div>

  </section>


  <!-- RIGHT -->
  <aside class="card col-4">
    <strong>Nama Member Baru Bergabung</strong>
    <div style="margin-top:8px; display:flex;gap:8px">
      <input id="newMemberName" placeholder="Nama Member">
      <button onclick="createMember()">Buat</button>
    </div>

    <div id="linkList" style="margin-top:10px;font-size:14px"></div>

    <hr style="margin:14px 0">

    <strong>Pengaturan Pembayaran</strong>
    <div style="margin-top:8px">
      <select id="payMethod">
        <option value="bank">Bank (Transfer)</option>
        <option value="dana">DANA</option>
      </select>
      <div style="margin-top:8px">
        <input id="payAccount" placeholder="No. Rek / DANA">
      </div>
      <div class="controls">
        <button onclick="savePayment()">Simpan</button>
        <button onclick="openWithdraw()" class="alt">Withdraw</button>
      </div>
    </div>

    <hr style="margin:14px 0">

    <strong>Material Promosi</strong>
    <ul id="materials" style="padding-left:16px"></ul>

  </aside>


  <!-- LOG -->
  <section class="card col-12">
    <strong>Log Aktivitas</strong>
    <div id="logArea" style="margin-top:8px;height:160px;overflow:auto;font-size:13px;color:var(--muted);
    background:rgba(255,255,255,0.6);padding:8px;border-radius:8px"></div>
  </section>

</main>

<footer>
  Demo affiliate — data lokal. Jangan gunakan untuk data sensitif.
</footer>


<!-- WITHDRAW MODAL -->
<div id="withdrawModal">
  <div id="withdrawBox">
    <h3>Ajukan Withdraw</h3>
    <label>Jumlah (angka)</label>
    <input type="number" id="wdAmount" style="width:100%;margin-bottom:8px">

    <label>Metode</label>
    <select id="wdMethod" style="width:100%;margin-bottom:8px">
      <option value="bank">Bank</option>
      <option value="dana">DANA</option>
    </select>

    <label>No. Rek / DANA</label>
    <input id="wdAccount" style="width:100%;margin-bottom:16px">

    <div style="display:flex;justify-content:flex-end;gap:8px">
      <button class="alt" onclick="closeWithdraw()">Batal</button>
      <button onclick="submitWithdraw()">Ajukan</button>
    </div>
  </div>
</div>


<script>
/* CONFIG */
const STORAGE_KEY = "affiliate_v2";
const COMMISSION = 150000;
const TAX = 5000;
const OWNER_NAME = "distributorutama"; // lowercase for case-insensitive matching

/* UTIL */
const qs = n => new URLSearchParams(location.search).get(n);
const rupiah = n => "Rp"+Number(n||0).toLocaleString("id-ID");
const gen = p => p+Math.random().toString(36).substring(2,9).toUpperCase();

/* DB */
function loadDB(){
  try{
    return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {members:{},logs:[],withdraws:[]};
  }catch(e){
    return {members:{},logs:[],withdraws:[]};
  }
}
function saveDB(db){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
  render();
}

/* CURRENT USER */
let currentUserRaw = qs("user") || "";
let currentUser = currentUserRaw.trim().toLowerCase();
if(!currentUser) currentUser = "anonymous";

/* OWNER CHECK (CASE INSENSITIVE) */
function isOwner(){
  return currentUser.toLowerCase() === OWNER_NAME.toLowerCase();
}

/* INITIALIZE MEMBER IF NOT EXISTS
   IMPORTANT: this function no longer calls saveDB() to avoid recursion
*/
function ensureMember(name){
  const key = name.trim().toLowerCase();
  const db = loadDB();
  if(!db.members[key]){
    db.members[key] = {name:name,balance:0,commissions:[]};
    // persist directly without calling saveDB() (to avoid calling render inside)
    localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
  }
  return db.members[key];
}

/* CREATE MEMBER (DOWNLINE) */
function createMember(){
  const name = document.getElementById("newMemberName").value.trim();
  if(!name) return alert("Isi nama member baru.");

  const key = name.toLowerCase();
  const db = loadDB();

  if(!db.members[key]){
    db.members[key] = {name:name,balance:0,commissions:[]};
  }

  const me = ensureMember(currentUser);

  me.commissions.unshift({
    id:gen("C"),time:new Date().toLocaleString(),biaya:"Pajak Member",
    jumlah:COMMISSION,status:"paid",from:name
  });

  me.balance += COMMISSION;
  db.logs.unshift({t:new Date().toLocaleString(),txt:`${me.name} dapat komisi dari ${name}`});

  const url = location.origin+location.pathname+"?user="+encodeURIComponent(name);

  document.getElementById("linkList").innerHTML =
  `<div style="background:white;padding:10px;border-radius:8px;margin-top:8px">
    <strong>${name}</strong><br>
    <small>Link member baru:</small>
    <input style="width:100%;border:0;background:transparent" value="${url}" readonly>
  </div>`;

  saveDB(db);
  document.getElementById("newMemberName").value="";
}

/* WITHDRAW */
function openWithdraw(){
  document.getElementById("withdrawModal").style.display="flex";
  document.getElementById("wdAccount").value =
    document.getElementById("payAccount").value || "";
}
function closeWithdraw(){ document.getElementById("withdrawModal").style.display="none"; }

function submitWithdraw(){
  const amt = Number(document.getElementById("wdAmount").value);
  const method = document.getElementById("wdMethod").value;
  const acc = document.getElementById("wdAccount").value.trim();

  if(amt<=0) return alert("Nominal salah");
  if(!acc) return alert("Isi nomor rekening");

  const db = loadDB();
  const me = ensureMember(currentUser);

  if(me.balance < amt) return alert("Saldo kurang");

  db.withdraws.unshift({
    id:gen("WD"),user:currentUser,name:me.name,
    amount:amt,fee:TAX,final:amt-TAX,
    method,account:acc,status:"pending",
    time:new Date().toLocaleString()
  });

  db.logs.unshift({t:new Date().toLocaleString(),txt:`${me.name} ajukan withdraw`});
  saveDB(db);

  closeWithdraw();
  alert("Withdraw diajukan. Owner akan memproses manual.");
}

/* OWNER APPROVE */
function approve(id){
  const db = loadDB();
  const wd = db.withdraws.find(x=>x.id===id);
  if(!wd) return;

  const m = ensureMember(wd.user);

  m.balance -= wd.amount;
  wd.status = "approved";
  wd.done = new Date().toLocaleString();

  db.logs.unshift({t:new Date().toLocaleString(),txt:`Owner approve withdraw ${wd.name}`});
  saveDB(db);

  alert("Withdraw approved. Transfer manual ke member.");
}

/* OWNER CANCEL */
function cancelWD(id){
  const db = loadDB();
  const wd = db.withdraws.find(x=>x.id===id);
  if(!wd) return;

  wd.status="cancelled";
  db.logs.unshift({t:new Date().toLocaleString(),txt:`Owner cancel withdraw ${wd.name}`});
  saveDB(db);
}

/* PP SETTINGS */
function savePayment(){
  const db = loadDB();
  const me = ensureMember(currentUser);

  me.method = document.getElementById("payMethod").value;
  me.account = document.getElementById("payAccount").value.trim();

  db.logs.unshift({t:new Date().toLocaleString(),txt:`${me.name} simpan pengaturan pembayaran`});
  saveDB(db);

  alert("Disimpan.");
}

/* EXPORT */
function exportCSV(){
  const db = loadDB();
  const me = ensureMember(currentUser);

  const rows = [
    ["time","order","biaya","jumlah","status"],
    ...me.commissions.map(c=>[c.time,c.id,c.biaya,c.jumlah,c.status])
  ];

  const csv = rows.map(r=>r.join(",")).join("\n");
  const blob = new Blob([csv],{type:"text/csv"});
  const url = URL.createObjectURL(blob);

  const a=document.createElement("a");
  a.href=url;a.download="commissions.csv";a.click();
  URL.revokeObjectURL(url);
}

/* DEMO */
function seedDemo(){
  const db = loadDB();
  db.members["distributorutama"]={name:"DistributorUtama",balance:450000,commissions:[]};
  db.logs.unshift({t:new Date().toLocaleString(),txt:"Demo data ditambahkan"});
  saveDB(db);
}

/* RESET */
function resetData(){
  if(confirm("Reset data?")){
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }
}

/* RENDER */
function render(){
  const db = loadDB();
  const me = ensureMember(currentUser);

  document.getElementById("title").innerText = me.name;
  document.getElementById("logoTxt").innerText = me.name.substring(0,2).toUpperCase();
  document.getElementById("balanceDisplay").innerText = "Saldo: "+rupiah(me.balance);
  document.getElementById("withdrawStatus").innerText = me.balance>0 ? "Ready" : "No Balance";

  /* KPI */
  const totalSales = me.commissions.length;
  const totalComm = me.commissions.reduce((s,c)=>s+c.jumlah,0);

  document.getElementById("totalClicks").innerText = 0;
  document.getElementById("totalSales").innerText = totalSales;
  document.getElementById("totalCommission").innerText = rupiah(totalComm);

  /* TABLE COMMISSIONS */
  const tb = document.getElementById("commissionTable");
  tb.innerHTML = me.commissions.map(c=>{
    return `<tr>
      <td>${c.time}</td>
      <td>${c.id}</td>
      <td>${c.biaya}</td>
      <td>${rupiah(c.jumlah)}</td>
      <td><span class="badge ${c.status}">${c.status}</span></td>
      <td></td>
    </tr>`;
  }).join("") || `<tr><td colspan="6" class="muted">Belum ada komisi</td></tr>`;

  /* LOGS */
  document.getElementById("logArea").innerHTML =
    db.logs.map(l=>`<div>${l.t} — ${l.txt}</div>`).join("");

  /* OWNER PANEL */
  const ownerArea = document.getElementById("ownerArea");
  if(isOwner()){
    ownerArea.style.display="block";

    const panel = document.getElementById("ownerPanel");
    panel.innerHTML = db.withdraws.map(w=>{
      return `<div style="padding:8px;border-bottom:1px solid #eee">
        <strong>${w.name}</strong><br>
        Amount: ${rupiah(w.amount)} — Final: ${rupiah(w.final)} <br>
        Metode: ${w.method} — Rek: ${w.account} <br>
        Status: ${w.status}<br>
        ${w.status==="pending"?
          `<button onclick="approve('${w.id}')">Approve</button>
           <button class="alt" onclick="cancelWD('${w.id}')">Cancel</button>` 
           :""}
      </div>`;
    }).join("") || "<div class='muted'>Belum ada withdraw</div>";

  } else {
    ownerArea.style.display="none";
  }

}

render();
</script>

</body>
</html>

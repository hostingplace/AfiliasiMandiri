<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Affiliate Dashboard — Sistem Uang Berputar</title>

<style>
  :root{
    --bg:#f3fbff;--card:#e6f7ff;--accent:#66c2ff;--accent-2:#8fd6ff;
    --muted:#6b8596;--glass: rgba(255,255,255,0.6);--success:#23c48a;
    --danger:#ff6b6b;font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,var(--bg),#eef9ff);color:#083042}
  .container{max-width:1100px;margin:28px auto;padding:20px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));
        display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
  h1{margin:0;font-size:20px}
  .sub{color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 20px rgba(6,30,45,0.06)}
  .col-4{grid-column:span 4}
  .col-8{grid-column:span 8}
  .col-12{grid-column:span 12}
  .overview{display:flex;gap:12px}
  .kpi{flex:1;padding:12px;border-radius:10px;background:rgba(255,255,255,0.5)}
  .kpi h3{margin:0;font-size:14px;color:var(--muted)}
  .kpi p{margin-top:8px;margin-bottom:0;font-weight:700;font-size:20px}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:8px;text-align:left}
  thead th{color:var(--muted);font-size:13px}
  tbody tr{border-top:1px solid rgba(8,48,66,0.06)}
  .badge{padding:6px 8px;border-radius:999px;font-size:12px;background:var(--glass)}
  .badge.pending{background:#fff3cd;color:#a37c00}
  .badge.paid{background:#e6f0ff;color:#1557ff}
  .badge.approved{background:#e6fff3;color:#23c48a}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  input,select{padding:8px;border-radius:8px;border:1px solid rgba(6,30,45,0.08);min-width:160px}
  button{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:white;cursor:pointer}
  button.alt{background:transparent;color:var(--accent);border:1px solid rgba(6,30,45,0.06)}
  footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
  .muted{color:var(--muted)}
  #ownerArea{display:none}
  .admin-panel{background:white;padding:12px;border-radius:10px;margin-top:12px}

  /* Withdraw modal */
  #withdrawModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.25);
    align-items:center;justify-content:center;}
  #withdrawBox{background:white;padding:18px;border-radius:12px;max-width:420px;width:90%;
    box-shadow:0 10px 30px rgba(0,0,0,0.2)}
  /* small responsive */
  @media (max-width:900px){ .col-8,.col-4{grid-column:span:12} .overview{flex-direction:column} }

/* RESPONSIVE FIX for Mobile */
@media (max-width: 768px) {

  header {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }

  .brand {
    width: 100%;
    justify-content: flex-start;
  }

  #balanceDisplay {
    font-size: 14px;
  }

  .grid {
    grid-template-columns: 1fr !important;
  }

  .col-8, .col-4, .col-12 {
    grid-column: span 12 !important;
  }

  .overview {
    flex-direction: column;
  }

  input, select {
    width: 100% !important;
  }

  .controls {
    flex-direction: column;
    width: 100%;
  }

  button {
    width: 100%;
  }

  #withdrawBox {
    width: 95% !important;
  }
}
  
</style>
</head>

<body>
<div class="container">

<header>
  <div class="brand">
    <div class="logo" id="logoTxt">AF</div>
    <div>
      <h1 id="title">Nama Member</h1>
      <div class="sub">Light blue theme — Sistem uang berputar (localStorage).</div>
    </div>
  </div>

  <div style="text-align:right">
    <div id="balanceDisplay" style="font-weight:700;font-size:16px">Saldo: Rp0</div>
    <div class="sub">Status: <span id="withdrawStatus">Ready</span></div>
  </div>
</header>

<main class="grid">

  <!-- LEFT -->
  <section class="card col-8">
    <div style="display:flex;justify-content:space-between;margin-bottom:10px">
      <strong>Ringkasan</strong>
      <div class="controls">
        <button class="alt" onclick="seedDemo()">Isi Demo</button>
        <button onclick="exportCSV()">Export CSV</button>
        <button class="alt" onclick="resetData()">Reset</button>
      </div>
    </div>

    <div class="overview">
      <div class="kpi"><h3>Total Klik</h3><p id="totalClicks">0</p></div>
      <div class="kpi"><h3>Total Penjualan</h3><p id="totalSales">0</p></div>
      <div class="kpi"><h3>Total Komisi</h3><p id="totalCommission">Rp0</p></div>
    </div>

    <hr style="border:none;height:12px">

    <strong>Riwayat Komisi</strong>
    <table>
      <thead>
        <tr><th>Waktu</th><th>Order</th><th>Biaya</th><th>Jumlah</th><th>Status</th><th>Aksi</th></tr>
      </thead>
      <tbody id="commissionTable"></tbody>
    </table>

    <div id="ownerArea">
      <strong>Panel Owner — Withdraw Requests</strong>
      <div class="admin-panel" id="ownerPanel"></div>
    </div>

  </section>

  <!-- RIGHT -->
  <aside class="card col-4">
    <strong>Nama Member Baru Bergabung</strong>
    <div style="margin-top:8px; display:flex;gap:8px">
      <input id="newMemberName" placeholder="Nama Member">
      <button onclick="createMember()">Buat</button>
    </div>

    <div id="linkList" style="margin-top:10px;font-size:14px"></div>

    <hr style="margin:14px 0">

    <strong>Pengaturan Pembayaran</strong>
    <div style="margin-top:8px">
      <select id="payMethod">
        <option value="bank">Bank (Transfer)</option>
        <option value="dana">DANA</option>
      </select>

      <div style="margin-top:8px">
        <input id="payAccount" placeholder="No. Rek / DANA">
      </div>

      <div class="controls">
        <button onclick="savePayment()">Simpan</button>
        <button onclick="openWithdraw()" class="alt">Withdraw</button>
      </div>
    </div>

    <hr style="margin:14px 0">

    <strong>Material Promosi</strong>
    <ul id="materials" style="padding-left:16px"></ul>

  </aside>

  <!-- LOG AREA -->
  <section class="card col-12">
    <strong>Log Aktivitas</strong>
    <div id="logArea" 
      style="margin-top:8px;height:160px;overflow:auto;font-size:13px;color:var(--muted);
             background:rgba(255,255,255,0.6);padding:8px;border-radius:8px">
    </div>
  </section>

</main>

<footer>
  Demo affiliate — data lokal. Jangan gunakan untuk data sensitif.
</footer>

<!-- WITHDRAW MODAL -->
<div id="withdrawModal">
  <div id="withdrawBox">
    <h3>Ajukan Withdraw</h3>

    <label>Jumlah (angka)</label>
    <input type="number" id="wdAmount" style="width:100%;margin-bottom:8px">

    <label>Metode</label>
    <select id="wdMethod" style="width:100%;margin-bottom:8px">
      <option value="bank">Bank</option>
      <option value="dana">DANA</option>
    </select>

    <label>No. Rek / DANA</label>
    <input id="wdAccount" style="width:100%;margin-bottom:16px">

    <div style="display:flex;justify-content:flex-end;gap:8px">
      <button class="alt" onclick="closeWithdraw()">Batal</button>
      <button onclick="submitWithdraw()">Ajukan</button>
    </div>
  </div>
</div>

<script>
/* CONFIG */
const STORAGE_KEY = "affiliate_v2";
const COMMISSION = 150000;
const TAX = 5000;
const OWNER_NAME = "distributorutama"; // canonical owner key (lowercase)

/* HELPERS */
const qs = n => new URLSearchParams(location.search).get(n);
const rupiah = n => "Rp"+Number(n||0).toLocaleString("id-ID");
const gen = p => p+Math.random().toString(36).substring(2,9).toUpperCase();

// Normalize display name: capitalize each word for nicer UI
function toDisplayName(raw){
  if(!raw) return raw;
  return raw.split(/\s+/).map(w => w.charAt(0).toUpperCase()+w.slice(1)).join(' ');
}

/* DB helpers */
function loadDB(){
  try{
    return JSON.parse(localStorage.getItem(STORAGE_KEY)) || { members:{}, logs:[], withdraws:[] };
  } catch(e){
    return { members:{}, logs:[], withdraws:[] };
  }
}
function saveDB(db){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
  render();
}

/* CURRENT USER (normalized key) */
let currentUserRaw = qs("user") || "";
let currentUser = currentUserRaw.trim().toLowerCase();

// Auto fallback: jika tidak ada ?user= maka treat as Owner
if(!currentUser) currentUser = OWNER_NAME.toLowerCase();

/* Owner check */
function isOwner(){
  return currentUser.toLowerCase() === OWNER_NAME.toLowerCase();
}

/* Ensure member exists (key always lowercase) */
/* This function will create a member record with a standardized display name if missing.
   It will not call render() to avoid recursion; caller should call saveDB() or render() as needed.
*/
function ensureMemberRecordByKey(key, optionalDisplayName){
  const db = loadDB();
  const k = (key||'').trim().toLowerCase();
  if(!k) return null;
  if(!db.members[k]){
    db.members[k] = {
      // store display-friendly name separately; preserve proper capitalization
      name: toDisplayName(optionalDisplayName || key),
      balance: 0,
      commissions: [],
      method: "",
      account: ""
    };
    // persist immediately
    localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
  }
  return db.members[k];
}

/* Create member (downline) and give commission to inviter (currentUser) */
function createMember(){
  const rawName = document.getElementById("newMemberName").value.trim();
  if(!rawName) return alert("Isi nama member baru.");

  const newKey = rawName.toLowerCase();
  const displayNew = toDisplayName(rawName);
  const db = loadDB();

  // ensure new member exists
  if(!db.members[newKey]){
    db.members[newKey] = {
      name: displayNew,
      balance: 0,
      commissions: [],
      method: "",
      account: ""
    };
  }

  // ensure inviter exists (currentUser)
  const inviterKey = (currentUser||'').trim().toLowerCase();
  if(!inviterKey) return alert("User tidak dikenali.");
  if(!db.members[inviterKey]){
    // create inviter record if missing (use key as display name if not provided)
    db.members[inviterKey] = {
      name: toDisplayName(currentUserRaw || inviterKey),
      balance: 0,
      commissions: [],
      method: "",
      account: ""
    };
  }

  // Add commission to inviter's account
  const commissionRecord = {
    id: gen("C"),
    time: new Date().toLocaleString(),
    biaya: "Pajak Member Baru",
    jumlah: COMMISSION,
    status: "paid",
    from: displayNew
  };

  db.members[inviterKey].commissions.unshift(commissionRecord);
  db.members[inviterKey].balance = (db.members[inviterKey].balance || 0) + COMMISSION;

  db.logs.unshift({ t: new Date().toLocaleString(), txt: `${db.members[inviterKey].name} dapat komisi dari ${displayNew}` });

  // create public link for the new member — use lowercase key for consistency
  const url = location.origin + location.pathname + "?user=" + encodeURIComponent(newKey);

  // persist and render
  saveDB(db);

  // show link
  document.getElementById("linkList").innerHTML =
    `<div style="background:white;padding:10px;border-radius:8px;margin-top:8px">
      <strong>${displayNew}</strong><br>
      <small>Link member baru:</small>
      <input style="width:100%;border:0;background:transparent" value="${url}" readonly>
    </div>`;

  document.getElementById("newMemberName").value = "";
}

/* Withdraw flows */
function openWithdraw(){
  document.getElementById("withdrawModal").style.display = "flex";
  document.getElementById("wdAccount").value = document.getElementById("payAccount").value || "";
}
function closeWithdraw(){ document.getElementById("withdrawModal").style.display = "none"; }

function submitWithdraw(){
  const amt = Number(document.getElementById("wdAmount").value);
  const method = document.getElementById("wdMethod").value;
  const acc = document.getElementById("wdAccount").value.trim();

  if(amt <= 0) return alert("Nominal tidak valid");
  if(!acc) return alert("Isi nomor rekening/DANA");

  const db = loadDB();
  const meKey = (currentUser||'').trim().toLowerCase();
  ensureMemberRecordByKey(meKey, currentUserRaw || meKey);
  const me = db.members[meKey];

  if(me.balance < amt) return alert("Saldo kurang");

  db.withdraws.unshift({
    id: gen("WD"),
    user: meKey,
    name: me.name,
    amount: amt,
    fee: TAX,
    final: Math.max(0, amt - TAX),
    method,
    account: acc,
    status: "pending",
    time: new Date().toLocaleString()
  });

  db.logs.unshift({ t: new Date().toLocaleString(), txt: `${me.name} ajukan withdraw` });

  saveDB(db);
  closeWithdraw();
  alert("Withdraw diajukan. Owner akan memproses secara manual.");
}

/* Owner actions */
function ownerApproveWithdraw(id){
  const db = loadDB();
  const wd = db.withdraws.find(x => x.id === id);
  if(!wd) return alert("Request tidak ditemukan");
  if(wd.status !== 'pending') return alert("Request bukan pending");

  const memberKey = (wd.user||'').trim().toLowerCase();
  ensureMemberRecordByKey(memberKey, wd.name);
  const member = db.members[memberKey];

  // decrease balance by full amount (owner does manual transfer)
  member.balance = (member.balance || 0) - (wd.amount || 0);
  if(member.balance < 0) member.balance = 0;

  wd.status = "approved";
  wd.done = new Date().toLocaleString();

  db.logs.unshift({ t: new Date().toLocaleString(), txt: `Owner approve withdraw ${wd.id} (${wd.name})` });
  saveDB(db);

  alert("Withdraw approved. Ingat untuk transfer manual ke nomor tujuan.");
}

function ownerCancelWithdraw(id){
  if(!confirm("Batalkan request ini?")) return;
  const db = loadDB();
  const wd = db.withdraws.find(x => x.id === id);
  if(!wd) return alert("Request tidak ditemukan");
  wd.status = "cancelled";
  db.logs.unshift({ t: new Date().toLocaleString(), txt: `Owner membatalkan withdraw ${wd.id} (${wd.name})` });
  saveDB(db);
}

/* Payment settings */
function savePayment(){
  const db = loadDB();
  const meKey = (currentUser||'').trim().toLowerCase();
  ensureMemberRecordByKey(meKey, currentUserRaw || meKey);
  db.members[meKey].method = document.getElementById("payMethod").value;
  db.members[meKey].account = document.getElementById("payAccount").value.trim();
  db.logs.unshift({ t: new Date().toLocaleString(), txt: `${db.members[meKey].name} menyimpan data pembayaran` });
  saveDB(db);
  alert("Pengaturan tersimpan.");
}

/* Export CSV (commissions for current user) */
function exportCSV(){
  const db = loadDB();
  const meKey = (currentUser||'').trim().toLowerCase();
  ensureMemberRecordByKey(meKey, currentUserRaw || meKey);
  const me = db.members[meKey];

  const rows = [
    ["time","order","biaya","jumlah","status"],
    ...((me.commissions || []).map(c => [c.time, c.id, c.biaya, c.jumlah, c.status]))
  ];

  const csv = rows.map(r => r.map(v => `"${String(v||'').replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = `commissions_${me.name.replace(/\s+/g,'_')}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

/* Demo data seed */
function seedDemo(){
  const db = loadDB();
  db.members = db.members || {};
  db.members[OWNER_NAME] = db.members[OWNER_NAME] || { name: "DistributorUtama", balance: 450000, commissions: [], method:"", account:"" };
  db.logs = db.logs || [];
  db.logs.unshift({ t: new Date().toLocaleString(), txt: "Demo data ditambahkan" });
  saveDB(db);
}

/* Reset */
function resetData(){
  if(!confirm("Reset semua data lokal?")) return;
  localStorage.removeItem(STORAGE_KEY);
  location.reload();
}

/* RENDER UI */
function render(){
  const db = loadDB();
  const meKey = (currentUser||'').trim().toLowerCase();
  // ensure record exists
  ensureMemberRecordByKey(meKey, currentUserRaw || meKey);
  const me = db.members[meKey];

  // header
  document.getElementById("title").innerText = me.name || toDisplayName(currentUserRaw || meKey);
  document.getElementById("logoTxt").innerText = (me.name||'AF').substring(0,2).toUpperCase();
  document.getElementById("balanceDisplay").innerText = "Saldo: " + rupiah(me.balance || 0);
  document.getElementById("withdrawStatus").innerText = (me.balance||0) > 0 ? "Ready" : "No Balance";

  // KPIs
  const totalSales = (me.commissions || []).length;
  const totalComm = (me.commissions || []).reduce((s,c)=>s + (c.jumlah||0), 0);
  document.getElementById("totalClicks").innerText = 0;
  document.getElementById("totalSales").innerText = totalSales;
  document.getElementById("totalCommission").innerText = rupiah(totalComm);

  // commission table
  const tb = document.getElementById("commissionTable");
  if((me.commissions || []).length === 0){
    tb.innerHTML = `<tr><td colspan="6" class="muted">Belum ada komisi</td></tr>`;
  } else {
    tb.innerHTML = (me.commissions || []).map(c => `
      <tr>
        <td>${c.time}</td>
        <td>${c.id}</td>
        <td>${c.biaya}</td>
        <td>${rupiah(c.jumlah)}</td>
        <td><span class="badge ${c.status}">${c.status}</span></td>
        <td></td>
      </tr>
    `).join("");
  }

  // logs
  document.getElementById("logArea").innerHTML = (db.logs || []).map(l => `<div>${l.t} — ${l.txt}</div>`).join("");

  // owner panel
  const ownerArea = document.getElementById("ownerArea");
  if(isOwner()){
    ownerArea.style.display = "block";
    const panel = document.getElementById("ownerPanel");
    if((db.withdraws || []).length === 0){
      panel.innerHTML = "<div class='muted'>Belum ada withdraw</div>";
    } else {
      panel.innerHTML = (db.withdraws || []).map(w => `
        <div style="padding:8px;border-bottom:1px solid #eee">
          <strong>${w.name}</strong><br>
          Amount: ${rupiah(w.amount)} — Final: ${rupiah(w.final)}<br>
          Metode: ${w.method} — Rek: ${w.account}<br>
          Status: ${w.status}<br>
          ${w.status === "pending" ? `
            <button onclick="ownerApproveWithdraw('${w.id}')">Approve</button>
            <button class="alt" onclick="ownerCancelWithdraw('${w.id}')">Cancel</button>
          ` : ""}
        </div>
      `).join("");
    }
  } else {
    ownerArea.style.display = "none";
  }
}

/* init */
render();

/* expose for debug */
window.createMember = createMember;
window.openWithdraw = openWithdraw;
window.closeWithdraw = closeWithdraw;
window.submitWithdraw = submitWithdraw;
window.savePayment = savePayment;
window.exportCSV = exportCSV;
window.seedDemo = seedDemo;
window.resetData = resetData;
window.ownerApproveWithdraw = ownerApproveWithdraw;
window.ownerCancelWithdraw = ownerCancelWithdraw;
</script>

</body>
</html>

